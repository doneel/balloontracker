<!DOCTYPE html>
<html>
          <head>
            <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
            <style type="text/css">
              html { height: 100% }
              body { height: 100%; margin: 0; padding: 0 }
              #map-canvas { height: 100%; width: 80%; float: left;}
              #controlBox {height: 90%; width: 20%; float: right; background: white;}
              .flightListBox{
                 -moz-box-shadow:    inset 0 0 5px #000000;
                 -webkit-box-shadow: inset 0 0 5px #000000;
                 box-shadow:         inset 0 0 10px #000000;
                 background-color: rgba(253, 253, 253, .4);
              }

              .flightBox{
                  height: 40px;
                  box-shadow: inset 0 0 3px #000000;
                  border: 1px solid black;
                  text-align: center;
              }

              .flightBox:hover{
                    box-shadow: inset 0 0 5px #1155AA;
                    cursor: pointer;
              }

              .flightTimeBox{
                   padding-bottom: 15px;
              }
            </style>
            <script type="text/javascript"
              src="https://maps.googleapis.com/maps/api/js?sensor=false">
            </script>

            <script type="text/javascript">
               document.write("\<script src='//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js' type='text/javascript'>\<\/script>");
            </script>

            <script type="text/javascript">
               var pathsList = JSON.parse({{.JsonFlightData}});
             </script>

            <script type="text/javascript">


              function initialize() {
                var mapOptions = {
                  center: new google.maps.LatLng(45.220, -111.761),
                  zoom: 8
                };
                var new_map = new google.maps.Map(document.getElementById("map-canvas"),
                    mapOptions);


               displayedLines = [];
               for(var i = pathsList.length - 1; i >= 0; i--){
                    flight = pathsList[i];
                    fullObj = buildFlightRepresentation(flight, new_map);
                    displayedLines[i] = fullObj

                    $(".flightListBox").append(fullObj.box);

               }


/*
                var longs = [-111.761, -111.601, -110.785, -110.074]
                var latits = [45.220, 45.268, 44.873, 44.082]

                var ll_arr = [];
                for(var i = 0; i < latits.length; i++){
                  console.log(latits[i], ' ', longs[i])
                  ll_arr[i] = new google.maps.LatLng(latits[i], longs[i]);
                }
                console.log(ll_arr);

                var Longpath = new google.maps.MVCArray(ll_arr);
                console.log(Longpath);



                var line = new google.maps.Polyline(lineOptions);
                */
              }

              google.maps.event.addDomListener(window, 'load', initialize);
            </script>

            <script>
               $(document).ready(function(){
                      $("#linesBox").on('change', function(evt){
                            showPaths(this.checked);
                     });

                     $("#markerBox").change(function(){
                            showMarkers(this.checked);
                     });

                     $("#opacityBox").change(function(){
                            scaleOpacities(this.checked);
                     });

                });

               function showMarkers(should){
                    var opts = {
                        visible: should
                    }
                    for(var i = 0; i < displayedLines.length; i++) {
                        displayedLines[i].marker.setOptions(opts);
                    }
               }

               function showPaths(should){
                  var opts = {
                    visible: should
                  }
                    for(var i = 0; i < displayedLines.length; i++) {
                        displayedLines[i].path.setOptions(opts);
                    }
               }

               function scaleFunction(x){
                    return Math.pow(Math.E, x * Math.log(.25) * 2);
               }

               function scaleOpacities(should){
                    var opts = {
                      opacity: 1
                    }

                    /*var shift = 1 - (displayedLines.length - 1)/displayedLines.length
                    var maxVal = scaleFunction((displayedLines.length - 1)/displayedLines.length)
                    console.log('Max Value ', maxVal)
                    for(var i = 0; i < displayedLines.length ; i++) {
                        closenessToEnd = (displayedLines.length - i) / displayedLines.length + shift;
                        opacity = scaleFunction(closenessToEnd)/maxVal;
                        console.log(opacity);
                        displayedLines[i].path.setOptions({strokeOpacity: !should || opacity}); //janky?
                        displayedLines[i].marker.setOptions(opts);
                    }
                    */

                    var newest = displayedLines[displayedLines.length - 1].date;
                    for(var i = 0; i < displayedLines.length; i++){
                          var timeGap = newest - displayedLines[i].date;
                          var dayGap = timeGap/(1000 * 60 * 60 * 24);
                          var decayFactor = Math.pow(.5, dayGap/30);
                          var opacity = 1 * decayFactor;
                          console.log(opacity);
                          displayedLines[i].path.setOptions({strokeOpacity: !should || opacity}); //janky?
                          var curColor = displayedLines[i].marker.icon.strokeColor;
                          displayedLines[i].marker.setOptions({icon: getIcon(curColor, !should || opacity)});
                    }
               }

               function getIcon(color, opacity){
                   options = {
                              path: google.maps.SymbolPath.CIRCLE,
                              scale: 5,
                              strokeColor: color,
                              strokeOpacity: .5
                          };
                          return options;
               }

               function buildFlightRepresentation(flight, map){
                    ll_path = [];
                    for(var reading = 0; reading < flight.Readings.length; reading++){
                          ll_path[reading] = new google.maps.LatLng(flight.Readings[reading].Latitude, flight.Readings[reading].Longitude)
                    }
                    var displayPath = new google.maps.MVCArray(ll_path)
                    var lineOptions = {
                      path : displayPath,
                      map : map,
                      editable: false,
                      draggable: false,
                      strokeColor: '#DD5522',
                      strokeOpacity: 1

                    };
                    var path = new google.maps.Polyline(lineOptions);


                    var marker = new google.maps.Marker({position: new google.maps.LatLng(flight.FinalLat, flight.FinalLong), icon: {
                              path: google.maps.SymbolPath.CIRCLE,
                              scale: 5,
                              strokeColor: '#CC1144',
                              strokeOpacity: .5
                          } , map: map});

                    google.maps.event.addListener(path, 'mouseover', function(event){
                         if(this.hilighted === true){
                              console.log('dont fire!')
                              return;
                         }
                         this.hilighted = true;
                         this.previousOpacity = this.strokeOpacity;
                         this.previousColor = this.strokeColor;
                         this.setOptions({strokeOpacity: 1, editable: false, strokeColor: '#1C8A00'});
                          console.log(marker.icon)
                          marker.prevColor = marker.icon.strokeColor;
                          marker.prevOpacity = marker.icon.strokeOpacity;
                          marker.setOptions({
                            icon: getIcon('#1C8A00', 1)
                          });
                    });

                    google.maps.event.addListener(path, 'mouseout', function(event){
                          this.hilighted = false;
                          opacity = this.previousOpacity;
                          color = this.previousColor;
                          console.log(this.previousOpacity)
                         this.setOptions({strokeOpacity: opacity , editable: false, strokeColor: color});
                         marker.setOptions({
                              icon: getIcon(marker.prevColor, marker.prevOpacity)
                         })
                    });

                    var containerDiv = document.createElement('div');
                    containerDiv.className = "flightBox";

                    $(containerDiv).on('click', {lat: flight.FinalLat, lon: flight.FinalLong, map: map}, function(evt){
                              evt.data.map.setOptions({center: new google.maps.LatLng(evt.data.lat, evt.data.lon), zoom: 10});
                    });


                    var dateP = document.createElement('p');
                    dateP.className = "flightTimeBox";

                    var date = new Date(flight.Timestamp);
                    dateP.innerHTML = (date.getMonth()+1) + "/" + date.getDate() + "/" + date.getFullYear() + " " + date.getHours() + ":00"

                    containerDiv.appendChild(dateP);


                    var context = this;

                    $(containerDiv).on('mouseover', {path:path}, function(evt){
                         google.maps.event.trigger(evt.data.path, 'mouseover');
                    });
                    $(containerDiv).on('mouseout', {path:path}, function(evt){
                         google.maps.event.trigger(evt.data.path, 'mouseout');
                    });

                    google.maps.event.addListener(marker, 'mouseover', function(event){
                           google.maps.event.trigger(path, 'mouseover') ;
                    });
                    google.maps.event.addListener(marker, 'mouseout', function(event){
                           google.maps.event.trigger(path, 'mouseout') ;
                    });


                    flightRepresentation = {path: path, marker: marker, box: containerDiv, date: date}
                    return flightRepresentation;

               }

          </script>


          </head>
          <body>
          <div id="map-canvas"></div>
          <div id="controlBox">
               <div class="buttonsBox">
                    <label>Show flight paths</label>
                    <input type="checkbox" id="linesBox" checked name="showLines" />
                    <br/>
                    <label>Show landing spots</label>
                    <input type="checkbox" id="markerBox" checked name="showMarkers" />
                    <br/>
                    <label>Fade older flights</label>
                    <input type="checkbox" id="opacityBox" unchecked name="scaleOpacity" />
               </div>
               <div class="flightListBox">

               </div>
          </div>
          </body>
</html>
